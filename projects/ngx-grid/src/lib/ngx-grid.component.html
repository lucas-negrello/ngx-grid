<div
  class="nxg-grid"
  [ngClass]="{
    'nxg--compact': gridOptions()?.density === 'compact',
    'nxg--striped': !!gridOptions()?.striped,
    'nxg--hover': gridOptions()?.hoverHighlight !== false,
    'nxg--sticky-header': !!gridOptions()?.stickyHeader
  }"
>
  <div class="nxg-grid__wrapper">
    <table
      class="nxg-table"
      [class]="gridOptions()?.tableClass || null"
      role="grid"
      aria-readonly="true"
      [attr.aria-rowcount]="paginationTotal()"
    >
      <thead>
      <tr>
        @for (col of effectiveColDefs(); track col.colId) {
          <th
            class="nxg-th"
            [attr.title]="col.headerTooltip || null"
            [style.text-align]="col.headerAlign || 'left'"
            [style.width]="col.width"
            [style.position]="'relative'"
            [class.nxg-th--sortable]="col.sortable !== false"
            (click)="onHeaderClick(col, $event)"
            [attr.aria-sort]="getSortFor(col) === 'none' ? 'none' : (getSortFor(col) === 'asc' ? 'ascending' : 'descending')"
            scope="col"
            [ngStyle]="getHeaderCellStyle(col)"
          >
            @if (headerTemplateMap().get(String(col.colId)); as hTpl) {
              <ng-container [ngTemplateOutlet]="hTpl.template"></ng-container>
            } @else {
              <span class="nxg-th__label">{{ col.headerName || col.field || col.colId }}</span>
            }
            @if (col.sortable !== false) {
              <span class="nxg-sort">
                <span class="nxg-sort__dir" [class.active]="getSortFor(col) === 'asc'">▲</span>
                <span class="nxg-sort__dir" [class.active]="getSortFor(col) === 'desc'">▼</span>
                @if (getSortIndexFor(col) !== null) {
                  <span class="nxg-sort__index">{{ getSortIndexFor(col)! + 1 }}</span>
                }
              </span>
            }
            <span class="nxg-th__filter" (click)="$event.stopPropagation()">
              <ngx-column-filter [col]="col"></ngx-column-filter>
            </span>

            @if (col.resizable !== false) {
              <span
                ngxColumnResizer
                [colId]="col.colId!"
                (click)="$event.stopPropagation()"
                style="position:absolute;top:0;right:-3px;width:6px;height:100%;cursor:col-resize;z-index:4;user-select:none"
                title="Arraste para redimensionar"
              ></span>
            }
          </th>
        }
      </tr>
      </thead>

      <tbody>
        @for (row of processedRows(); track trackRow(i, row); let i = $index) {
          <tr
            class="nxg-tr"
            [ngClass]="gridOptions()?.rowClass?.({ data: row, index: i }) || null"
            (click)="onRowClick(row, i, $event)"
            [class.nxg-tr--selected]="isSelected(row, i)"
            role="row"
            [attr.aria-selected]="isSelected(row, i)"
          >
            @for (col of effectiveColDefs(); track col.colId) {
              <td
                class="nxg-td"
                [ngClass]="getCellClassList(row, col, i)"
                [style.text-align]="col.align || 'left'"
                [ngStyle]="getBodyCellStyle(col)"
              >
                @if (cellTemplateMap().get(String(col.colId)); as cTpl) {
                  <ng-container
                    [ngTemplateOutlet]="cTpl.template"
                    [ngTemplateOutletContext]="{
                    $implicit: getCellFormattedValue(row, col, i),
                    value: getCellFormattedValue(row, col, i),
                    data: row,
                    row: row,
                    colDef: col,
                    colId: col.colId
                  }"
                  ></ng-container>
                } @else {
                  @if (col.cellRenderer) {
                    {{ getCellRenderOutput(row, col, i) }}
                  } @else {
                    {{ getCellFormattedValue(row, col, i) }}
                  }
                }
              </td>
            }
          </tr>
        }

        @if (processedRows().length === 0) {
          <tr>
            <td class="nxg-empty" [attr.colspan]="(effectiveColDefs()?.length || 0)">
              Nenhum registro encontrado.
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <div class="nxg-paginator">
    <div class="nxg-paginator__info">
      <span>Total: {{ paginationTotal() }}</span>
      <span> • Página: {{ paginationPageIndex() + 1 }} / {{ paginationTotalPages() }}</span>
    </div>
    <div class="nxg-paginator__actions">
      <label>
        Linhas por página:
        <select [value]="paginationPageSize()" (change)="onPaginationSetPageSize(Number($any($event.target).value))">
          @for (size of (gridOptions()?.paginationPageSizeOptions ?? [10,25,50]); track size) {
            <option [value]="size">{{ size }}</option>
          }
        </select>
      </label>
      <div class="nxg-paginator__buttons">
        <button type="button" (click)="onPaginationFirst()" [disabled]="paginationPageIndex() === 0">Primeira</button>
        <button type="button" (click)="onPaginationPrev()" [disabled]="paginationPageIndex() === 0">Anterior</button>
        <button type="button" (click)="onPaginationNext()" [disabled]="paginationPageIndex() >= (paginationTotalPages() - 1)">Próxima</button>
        <button type="button" (click)="onPaginationLast()" [disabled]="paginationPageIndex() >= (paginationTotalPages() - 1)">Última</button>
      </div>
    </div>
  </div>
</div>
